传输层协议

1.TCP

2.UDP

# ==TCP协议==

#### 回顾内容

1.传输层的功能：定义应用层协议数据报文的端口号，流量控制

2.对原始数据进行分段处理

#### 输出层所提供的服务

1.传输连接服务

2.数据传输服务：流量控制，差错控制，序列控制

# 一、传输层的TCP协议

#### 1.面向连接的传输协议（TCP）

- 要求数据在传输之前必须建立连接，数据传输完成之后，必须释放连接
- 仅支持单播传输：在两个终端之间建立点对点的链接

#### 2.UDP（用户数据报协议）

# 二、TCP的报文字段

<img src="C:\Users\hp\AppData\Roaming\Typora\typora-user-images\image-20230811154729270.png" alt="image-20230811154729270" style="zoom:200%;" />

字段含义

- TCP源端口 (Source Port) : 源计算机上的应用程序的端口号，占16位
- TCP目的端口 (Destination Port) : 目标计算机的应用程序端口号，占16位
- 序号(Sequence Number):占32 位。它表示本报文段所发送数据的第一个字节的编号。在TCP 连接中，所传送的字节流的每一个字节都会按顺序编号。当SYN标记不为1时，这是当前数据分段第一个字母的序列号;如果SYN的值是1时，这个字段的值就是初始序列值(ISN)，用于对序列号进行同步。这时，第一个字节的序列号比这个字段的值大1，也就是ISN加1
- TCP 确认号(Acknowledgment Number，AK Number): 占32位它表示接收方期望收到发送方下一个报文段的第一个字节数据的编号。其值是接收计算机即将接收到的下一个席列号，也就是下一个接收到的字节的席列号加1
- TCP 首部长度(Header Length): 数偏移是指数据段中的“数据"部分起始处距离 TCP 数据段起始处的字节偏移量，占 4 位，其实这里的“数据偏移”也是在确定 TCP 数据段头部分的长度，告诉接收端的应用程序，数据从何处开始
- 保留(Reserved):占4位。为TCP 将来的发展预留空间，目前必须全部为 0
- URG(Urgent):表示本报文段中发送的数据是否包含紧急数据。URG=1 时表示有紧急数据。当 URG=1 时，后面的紧急指针字段才有效
- ACK:表示前面的确认号字段是否有效。ACK=1 时表示有效，只有当 ACK=1 时，前面的确认号字段才有效。TCP 规定，连接建立后，ACK 必须为 1
- PSH(Push):告诉对方收到该报文段后是否立即把数据推送给上层。如果值为 1，表示应当立即把数据提交给上层，而不是缓存起来
- RST:表示是否重置连接如果 RST=1，说明 TCP 连接出现了严重错误(如主机崩溃)，必须释放连接，然后再重新建立连接
- SYN:在建立连接时使用，用来同步序号，当 SYN=1，ACK=0时，表示这是一个请求建立连接的报文段，当SYN=1，ACK=1时，表示对方同意建立连接。SYN=1 时，说明这是一个请求建立连接或同意建立连接的报文。只有在前两次握手中 SYN 才为1
- FIN:标记数据是否发送完毕。如果 FIN=1，表示数据已经发送完成，可以释放连接
- 窗口大小(Window Size):占16 位，它表示从Ack Number 开始还可以接收多少字节的数据量，也表示当前接收端的接收窗口还有多少剩余空间。该字段可以用于 TCP 的流量控制
- 校验和(TCP (hecksum):占 16 位，它用于确认传输的数据是否有损坏，发送端基于数据内容校验生成一个数值，接收端根据接收的数据校验生成一个值，两个值必须相同，才能证明数据是有效的，如果两个值不同，则丢掉这个数据包。(hecksum 是根据伪头+TCP头+TCP数据三部分进行计算的
- 紧急指针(Urgent Pointer): 仅当前面的 URG 控制位为1时才有意义，它指出本数据段中为紧急数据的字节数，占 16 位，当所有紧急数据处理完后，TP 就会告诉应用程序恢复到正常操作。即使当前窗口大小为 0，也是可以发送紧急数据的，因为紧急数据无须缓存
- 选项(Option): 长度不定，但长度必须是32bits 的整数倍

### 1.TCP建立连接的三次握手

<img src="C:\Users\hp\AppData\Roaming\Typora\typora-user-images\image-20230811162413175.png" alt="image-20230811162413175" style="zoom:200%;" />

这个可以根据我们进行抓取报文来观察，第一次client像server发送SYN=1，此时ACK=0，表示client向server请求建立连接，并且伴随着有一个序列号seq=x（x是一个随机值），server接收到请求后，一般情况下会对client进行回应

server发送SYN=1（也相当于server告诉client，你可以给我发送请求了），ACK=1，此时表示server同意client的建立连接，伴随着ack（确认的序列号，为了确认上一个请求的seq是有效的）=x+1，和新的序列号（新的seq是属于这个新的报文当中的seq序列号，可以理解为每一个报文中都会有一个专属的序列号，作用相当于上一个请求报文中的seq）seq=y产生，一并发送给client

client收到server发来的确认，接下来client要向server发送确认，确认client收到了server的确认，ACK=1，（此时是没有SYN的，因为SYN是用来请求和确认建立连接的，现在请求和建立都已经结束了，当然就没有SYN了），然后ack=y+1，还有一个seq=x+1，但这里的seq并没有什么意义

### 2.TCP释放连接的四次挥手

<img src="C:\Users\hp\AppData\Roaming\Typora\typora-user-images\image-20230811203754576.png" alt="image-20230811203754576" style="zoom:200%;" />

server数据服务提供完成，告诉client我已经给你提供完成数据了，然后client会向server确认自己已经收到了完整的数据，然后顺便就会发送FIN+ACK，请求释放连接，server收到之后会发送一个确认收到数据的ACK报文，紧接着就会发送断开连接的报文，断开后client会返回确认信息

### 3.TCP半关闭状态

### 4.TCP半连接状态

<img src="C:\Users\hp\AppData\Roaming\Typora\typora-user-images\image-20230811210418530.png" alt="image-20230811210418530" style="zoom:200%;" />

然后多次这样进行操作，就会大量的占用服务器的资源情况

5.常见的TCP的端口号

| port | protocol |
| ---- | -------- |
| 21   | FTP      |
| 22   | SSH      |
| 23   | TELNET   |
| 25   | SMPT     |
| 53   | DNS      |
| 80   | HTTP     |
| 110  | POP3     |
| 143  | IMAP4    |
| 443  | HTTPS    |
| 3306 | MYSQL    |
| 3389 | RDP      |

